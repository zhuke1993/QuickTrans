# 开发与测试指南

<cite>
**本文档引用的文件**
- [background.js](file://background.js)
- [content.js](file://content.js)
- [content.css](file://content.css)
- [demo.sh](file://demo.sh)
- [TRANSLATOR_TESTING_GUIDE.md](file://TRANSLATOR_TESTING_GUIDE.md)
- [TTS_TESTING_GUIDE.md](file://TTS_TESTING_GUIDE.md)
- [manifest.json](file://manifest.json)
- [storage-utils.js](file://storage-utils.js)
- [options.js](file://options.js)
</cite>

## 目录
1. [调试方法](#调试方法)
2. [代码修改](#代码修改)
3. [demo.sh脚本说明](#demoscript说明)
4. [测试策略](#测试策略)
5. [构建与打包](#构建与打包)

## 调试方法

### 查看后台服务工作线程日志
后台服务工作线程（Service Worker）负责处理翻译请求、API配置管理和数据存储。要查看其日志，请按以下步骤操作：
1. 打开Chrome浏览器，访问 `chrome://extensions/`。
2. 找到"QuickTrans"扩展，点击"Service Worker"链接。
3. 在打开的开发者工具控制台中查看日志输出。

**Section sources**
- [manifest.json](file://manifest.json#L16-L18)
- [background.js](file://background.js)

### 在网页开发者工具中调试content.js
`content.js` 是内容脚本，负责监听用户文本选择事件、显示翻译图标和弹窗。调试方法如下：
1. 在任意网页上按 `F12` 打开开发者工具。
2. 切换到"Console"（控制台）标签页。
3. 选择正确的上下文（通常为"top"或页面域名），即可查看 `content.js` 的日志。

**Section sources**
- [content.js](file://content.js)
- [manifest.json](file://manifest.json#L19-L26)

### 检查chrome.storage中的数据
插件使用 `chrome.storage` API 进行数据持久化。检查存储数据的方法：
1. 在网页上按 `F12` 打开开发者工具。
2. 进入"Application"（应用）标签页。
3. 在左侧边栏选择"Storage" -> "chrome.storage"。
4. 查看 `local`（存储API配置和缓存）和 `sync`（存储用户偏好设置）中的数据。

**Section sources**
- [storage-utils.js](file://storage-utils.js)
- [background.js](file://background.js)

## 代码修改

### 更改默认模型
要更改后台服务中调用的默认大语言模型，请修改 `background.js` 文件。具体步骤如下：
1. 打开 `background.js` 文件。
2. 找到 `callLLMAPI` 函数。
3. 修改 `requestBody` 对象中的 `model` 参数为你希望使用的模型名称。

```javascript
const requestBody = {
  model: 'gpt-4', // 将此处改为你的目标模型，如 'gpt-4-turbo'
  messages: [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ],
  temperature: temperature,
  max_tokens: 10000,
  stream: useStream
};
```

**Section sources**
- [background.js](file://background.js#L222)

### 自定义UI样式
要自定义翻译弹窗和图标的样式，请修改 `content.css` 文件。该文件包含了所有与用户界面相关的CSS规则，例如：
- `.ai-translate-icon`：翻译触发图标的样式。
- `.ai-translate-popup`：翻译弹窗的整体样式。
- `.ai-translate-popup-header`：弹窗头部的渐变背景和布局。

修改这些CSS类可以改变插件的视觉外观，如颜色、字体、圆角和阴影等。

**Section sources**
- [content.css](file://content.css)

## demo.sh脚本说明

`demo.sh` 是一个用于快速演示和验证项目完整性的Bash脚本。其主要用途和运行方式如下：

### 用途
1. **项目完整性检查**：脚本会检查项目必需的文件（如 `manifest.json`, `background.js` 等）是否存在。
2. **代码统计**：自动统计项目中JavaScript、CSS和HTML文件的总行数。
3. **安装指南**：提供在Chrome浏览器中加载扩展的详细步骤。
4. **功能清单**：列出插件已实现的核心功能。
5. **文档指引**：提示可用的文档资源。
6. **配置验证**：最后会验证 `manifest.json` 文件的JSON格式是否正确。

### 运行方式
1. 确保你位于项目根目录下。
2. 在终端中运行以下命令：
   ```bash
   bash demo.sh
   ```
   或者，如果脚本有执行权限，可以直接运行：
   ```bash
   ./demo.sh
   ```
3. 脚本将输出检查结果、统计信息和安装说明。

**Section sources**
- [demo.sh](file://demo.sh)

## 测试策略

### 单元测试和功能测试
根据 `TRANSLATOR_TESTING_GUIDE.md` 和 `TTS_TESTING_GUIDE.md` 文档，测试策略分为以下两个部分：

#### 翻译功能测试 (TRANSLATOR_TESTING_GUIDE.md)
该指南提供了一套完整的功能测试清单，确保翻译页面的核心功能正常工作。主要测试项包括：
- **Popup菜单测试**：验证点击插件图标后，"翻译页面"和"设置"按钮能正确跳转。
- **剪贴板读取测试**：验证打开翻译页面时能自动填充剪贴板内容。
- **手动输入翻译测试**：验证输入文本后能正确流式显示翻译结果。
- **粘贴和清空按钮测试**：验证"粘贴"和"清空"按钮功能正常。
- **复制译文测试**：验证翻译结果能成功复制到剪贴板。
- **语言切换测试**：验证切换目标语言后，偏好设置能被保存。
- **划词词典查询测试**：验证在输入框中选中单个英文单词时，能正确弹出词典查询窗口。
- **快捷键测试**：验证 `Ctrl+Shift+T` (Mac: `Command+Shift+T`) 能正确打开翻译页面。
- **右键菜单测试**：验证右键菜单中的"翻译选中文本"和"在翻译页面中打开"功能正常。
- **错误处理测试**：验证在未配置API或文本过长时，能显示友好的错误提示。
- **响应式布局测试**：验证在不同屏幕尺寸下，界面布局都能正常显示。

**Section sources**
- [TRANSLATOR_TESTING_GUIDE.md](file://TRANSLATOR_TESTING_GUIDE.md)

#### TTS功能测试 (TTS_TESTING_GUIDE.md)
该指南专注于测试文本转语音（TTS）功能。主要测试项包括：
- **UI显示测试**：验证在词典弹窗中，单词和句子旁的发音按钮（🔊图标）能正确显示。
- **发音功能测试**：验证点击发音按钮后，能成功合成并播放音频。
- **播放控制测试**：验证点击正在播放的按钮能停止音频。
- **弹窗关闭测试**：验证在播放过程中关闭词典弹窗，音频会自动停止。
- **错误处理测试**：验证在未配置TTS API或网络错误时，能显示相应的错误提示。
- **配置测试**：验证修改TTS模型、音色和音频格式后，新配置能生效。
- **性能与兼容性测试**：验证长单词和长句子的发音性能，以及在不同网站上的兼容性。

**Section sources**
- [TTS_TESTING_GUIDE.md](file://TTS_TESTING_GUIDE.md)

## 构建与打包

为了确保二次开发和贡献的顺利进行，建议遵循以下构建和打包流程：

1. **代码修改与测试**：
   - 在本地修改代码（如 `background.js`, `content.css`）。
   - 使用上述调试方法验证功能。
   - 运行 `demo.sh` 脚本确保项目完整性。

2. **加载到Chrome进行测试**：
   - 打开Chrome浏览器，访问 `chrome://extensions/`。
   - 开启"开发者模式"。
   - 点击"重新加载"按钮，更新已加载的扩展程序。

3. **打包发布**：
   - 在 `chrome://extensions/` 页面，找到QuickTrans扩展。
   - 点击"打包扩展程序"按钮。
   - 选择项目根目录，点击"打包扩展程序"。
   - 这将生成一个 `.crx` 文件和一个私钥文件（`.pem`），可用于分发或发布到Chrome应用商店。

4. **版本管理**：
   - 每次发布新版本时，记得在 `manifest.json` 中更新 `version` 字段。
   - 在 `README.md` 的更新日志中记录变更内容。

遵循此流程，可以确保代码的稳定性和可维护性，方便其他开发者进行贡献。

**Section sources**
- [manifest.json](file://manifest.json#L4)
- [README.md](file://README.md#L319-L327)